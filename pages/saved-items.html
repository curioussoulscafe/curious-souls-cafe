<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Curious Souls Caf√© - Saved Items (Questions & Actions)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <style>
    :root { --highlight-color: #57FCFF; }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to right, #f3f4f6 0%, #ede9fe 20%, #ede9fe 80%, #f3f4f6 100%);
    }

    .topic-card {
      background-color: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 1rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.06);
    }

    .question-chip, .action-chip {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      background-color: #f8fafc;
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 0.9rem 0.9rem;
      transition: background 0.15s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.15s;
      cursor: pointer;
    }
    .question-chip:hover, .action-chip:hover {
      background-color: #eef2ff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .selected-chip {
      background-color: var(--highlight-color);
      transform: scale(1.02);
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }

    .question-text, .action-text {
      font-size: 1rem;
      color: #111827;
    }
    .question-actions button, .action-actions button {
      border-radius: 9999px;
      padding: 0.35rem 0.6rem;
      font-size: 0.85rem;
      font-weight: 600;
      transition: transform 0.1s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    .question-actions button:active, .action-actions button:active {
      transform: scale(0.98);
    }

    .pill {
      border: 1px solid #d1d5db;
      background-color: #ffffff;
      color: #4b5563;
      font-weight: 600;
      border-radius: 9999px;
      padding: 0.4rem 0.75rem;
      font-size: 0.9rem;
      transition: background 0.15s, color 0.15s, border-color 0.15s, box-shadow 0.15s;
    }
    .pill:hover { background-color: #f3f4f6; }
    .danger { background-color: #fee2e2; color: #991b1b; border-color: #fecaca; }
    .danger:hover { background-color: #fecaca; }
    .primary { background-color: #8b5cf6; color: #ffffff; border-color: #8b5cf6; }
    .primary:hover { background-color: #7c3aed; }
    .muted { background-color: #f3f4f6; color: #374151; border-color: #e5e7eb; }
    .muted:hover { background-color: #e5e7eb; }

    .section-title { color: #6b46c1; }
    .subtle { color: #6b7280; }

    .empty-state {
      background: #f8fafc;
      border: 1px dashed #d1d5db;
      padding: 1rem;
      border-radius: 0.75rem;
      color: #6b7280;
      text-align: center;
    }

    .search-input {
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      padding: 0.6rem 0.8rem;
      width: 100%;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .search-input:focus {
      border-color: #8b5cf6;
      box-shadow: 0 0 0 3px rgba(139,92,246,0.25);
    }

    .badge {
      background: #ede9fe;
      color: #6b46c1;
      border-radius: 9999px;
      padding: 0.2rem 0.55rem;
      font-size: 0.75rem;
      font-weight: 700;
    }

    .toolbar {
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid #e5e7eb;
    }

    /* Floating buttons */
    #back-to-top {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #6b46c1;
      color: white;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border-radius: 9999px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      cursor: pointer;
      display: none;
      transition: opacity 0.3s ease-in-out, transform 0.15s ease-in-out;
      z-index: 1000;
    }
    #back-to-top:hover { background-color: #805ad5; transform: translateY(-2px); }

    #floating-dice, #floating-lookup, #floating-share {
      position: fixed;
      right: 20px;
      width: 56px; height: 56px;
      border-radius: 9999px;
      color: #ffffff;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
      text-decoration: none;
      transition: transform 0.15s ease-in-out, box-shadow 0.2s ease-in-out, filter 0.2s;
    }
    #floating-dice {
      bottom: 80px;
      background: linear-gradient(135deg, #10b981, #06b6d4);
      z-index: 1100;
    }
    #floating-dice:hover, #floating-dice:focus { transform: translateY(-2px) scale(1.03); box-shadow: 0 10px 18px rgba(0,0,0,0.2); outline: none; filter: brightness(1.05); }
    #floating-dice .fa-dice { font-size: 1.4rem; }

    #floating-lookup {
      bottom: 148px;
      background: linear-gradient(135deg, #3b82f6, #10b981);
      display: none;
      z-index: 1150;
      cursor: pointer;
    }
    #floating-lookup i { font-size: 1.25rem; }
    #floating-lookup:hover, #floating-lookup:focus { transform: translateY(-2px) scale(1.03); box-shadow: 0 10px 18px rgba(0,0,0,0.2); outline: none; filter: brightness(1.05); }

    #floating-share {
      bottom: 214px;
      background: linear-gradient(135deg, #a855f7, #ec4899);
      display: none;
      z-index: 1130;
      cursor: pointer;
    }
    #floating-share i { font-size: 1.15rem; }
    #floating-share:hover, #floating-share:focus { transform: translateY(-2px) scale(1.03); box-shadow: 0 10px 18px rgba(0,0,0,0.2); outline: none; filter: brightness(1.05); }

    @media (max-width: 480px) {
      #floating-dice { width: 52px; height: 52px; bottom: 76px; right: 16px; }
      #floating-dice .fa-dice { font-size: 1.25rem; }
      #back-to-top { bottom: 16px; right: 16px; }
      #floating-lookup { width: 52px; height: 52px; right: 16px; bottom: 140px; }
      #floating-lookup i { font-size: 1.15rem; }
      #floating-share { width: 52px; height: 52px; right: 16px; bottom: 204px; }
      #floating-share i { font-size: 1.05rem; }
    }

    /* Modal system */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.6);
      display: flex; justify-content: center; align-items: center;
      z-index: 2000;
      opacity: 0; visibility: hidden;
      transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
    }
    .modal-overlay.show { opacity: 1; visibility: visible; }
    .modal-content {
      background-color: white;
      padding: 1.5rem;
      border-radius: 0.75rem;
      box-shadow: 0 10px 15px rgba(0,0,0,0.2);
      text-align: center;
      max-width: 360px; width: 90%;
      transform: translateY(-20px);
      transition: transform 0.3s ease-in-out;
    }
    .modal-overlay.show .modal-content { transform: translateY(0); }
    .modal-buttons { display: flex; justify-content: center; gap: 0.75rem; margin-top: 1.25rem; }
    .modal-button { padding: 0.6rem 1.2rem; border-radius: 9999px; font-weight: 700; cursor: pointer; transition: all 0.2s ease-in-out; }
    .modal-button.cancel { background: #e2e8f0; color: #4a5568; }
    .modal-button.cancel:hover { background: #cbd5e0; }

    /* Getting Started modal specifics */
    .getting-started-list { list-style: none; padding-left: 0; text-align: left; counter-reset: step-counter; }
    .getting-started-list li { margin-bottom: 0.75rem; padding-left: 1.5rem; position: relative; }
    .getting-started-list li::before {
      content: counter(step-counter); counter-increment: step-counter;
      position: absolute; left: 0; top: 0;
      background-color: #9f7aea; color: white; border-radius: 50%;
      width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;
      font-size: 0.8rem; font-weight: bold;
    }
    #inline-share-trigger {
      background: none; border: none; padding: 0; margin: 0; color: #0000EE; font-style: italic; cursor: pointer;
    }
    #inline-share-trigger:hover, #inline-share-trigger:focus { text-decoration: underline; color: #551A8B; outline: none; }

    /* Choice buttons in lookup modal */
    .choice-btn {
      background-color: #8b5cf6; color: white; font-weight: bold;
      padding: 0.5rem 1rem; font-size: 0.9rem; border-radius: 9999px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      cursor: pointer; transition: all 0.25s ease-in-out;
      display: flex; align-items: center; justify-content: center; margin-bottom: 0.5rem;
    }
    .choice-btn i { margin-right: 0.5rem; }
    .choice-btn:hover { filter: brightness(0.95); transform: translateY(-1px); }

    /* Description link row */
    .description-link-container {
      display: flex; justify-content: center; align-items: center;
      margin-top: -0.25rem; margin-bottom: 0.75rem; font-size: 0.95rem; color: #6b46c1; gap: 0.5rem;
    }
    .description-link {
      display: inline-flex; align-items: center; color: #6b46c1; font-weight: 500; text-decoration: none;
      background: none; border: none; cursor: pointer; padding: 0;
    }
    .description-link:hover { color: #805ad5; text-decoration: underline; }
    .description-link i { margin-right: 0.35rem; }
    .separator { color: #6b46c1; opacity: 0.7; }

    /* Bottom tip and QR link */
    .bottom-tip {
      display: flex; align-items: center; justify-content: center; gap: 0.5rem;
      color: #4b5563; background: #f3f4f6; border: 1px dashed #d1d5db;
      border-radius: 9999px; padding: 0.5rem 0.875rem; font-size: 0.9rem; margin-top: 0.75rem; user-select: none;
    }
    .bottom-tip i { color: #f59e0b; }
    .qr-code-link {
      font-size: 0.875rem; color: #6b46c1; text-decoration: none;
      transition: color 0.2s ease-in-out, text-decoration 0.2s ease-in-out;
      display: inline-flex; align-items: center; gap: 0.35rem; justify-content: center;
    }
    .qr-code-link:hover { color: #805ad5; text-decoration: underline; }

    /* Small helpers */
    .nowrap { white-space: nowrap; }
    .wrap-anywhere { overflow-wrap: anywhere; }
  </style>
</head>
<body class="bg-gray-100 flex justify-center items-start min-h-screen p-4">
  <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md transition-transform">
    <div class="flex justify-center mb-6">
      <a href="../index.html" aria-label="Back to Home">
        <img src="../images/csc_logo.jpg" alt="Curious Souls Cafe Logo" class="w-24 h-24 rounded-full border-2 border-purple-500">
      </a>
    </div>
    <h1 class="text-2xl font-semibold text-purple-600 text-center mb-2">Curious Souls Caf√©</h1>
    <hr class="border-purple-300 mb-4 w-1/2 mx-auto">

    <h2 class="text-xl font-semibold text-purple-600 text-center mb-1">Saved Items</h2>
    <p class="text-center subtle mb-2">Items saved across the app ‚Ä¢ Manage, copy, or clear</p>

    <!-- Description/get started row -->
    <div class="description-link-container">
      <button id="getting-started-link" class="description-link">
        <i class="fas fa-info-circle"></i> Get started
      </button>
      <!-- <span class="separator">|</span>
      <a href="../index.html" class="description-link" title="About this page">About this page</a> -->
    </div>

    <!-- Top toolbar -->
    <div class="toolbar -mx-8 px-8 py-3 flex flex-col gap-2">
      <div class="flex gap-2">
        <input id="search-input" type="text" class="search-input" placeholder="Search across saved items...">
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="clear-all-btn" class="pill danger"><i class="fa-solid fa-trash-can mr-1"></i>Clear All Saved</button>
        <button id="export-all-btn" class="pill primary"><i class="fa-solid fa-file-arrow-down mr-1"></i>Export All</button>
        <button id="expand-all-btn" class="pill muted"><i class="fa-solid fa-angles-down mr-1"></i>Expand All</button>
        <button id="collapse-all-btn" class="pill muted"><i class="fa-solid fa-angles-up mr-1"></i>Collapse All</button>
        <a href="../index.html" class="pill"><i class="fa-solid fa-house mr-1"></i>Home</a>
      </div>
    </div>

    <!-- Summary -->
    <div id="summary" class="mt-4 mb-2 text-sm subtle"></div>

    <!-- Results Container -->
    <div id="results" class="space-y-4 mt-2"></div>

    <!-- Saved Actions mount -->
    <div id="actions-mount"></div>

    <!-- Empty state -->
    <div id="empty-state" class="empty-state mt-6 hidden">
      <p class="mb-2">No saved items found.</p>
      <p class="text-sm">Open any topic to save items, or select actions on the Action Prompts page, then check back here.</p>
    </div>

    <!-- Bottom tip and QR -->
    <div class="bottom-tip mt-6" aria-live="polite">
      <i class="fa-solid fa-lightbulb"></i>
      <span>Tap the top logo for home</span>
    </div>
    <div class="mt-3 text-center">
      <a href="#" id="show-qr-code-link" class="qr-code-link">
        <i class="fas fa-qrcode"></i> Share page/QR code
      </a>
    </div>
  </div>

  <!-- Floating buttons -->
  <a id="floating-dice" href="dice.html" aria-label="Open Dice Roller" title="Open Dice Roller">
    <i class="fas fa-dice"></i>
  </a>
  <button id="floating-lookup" title="Look Up Online / Translate" aria-label="Look Up Online / Translate">
    <i class="fas fa-search"></i>
  </button>
  <button id="floating-share" title="Share selected text" aria-label="Share selected text">
    <i class="fas fa-share-nodes"></i>
  </button>
  <button id="back-to-top" title="Back to Top">&#9650; Top</button>

  <!-- Search/Translate Choice Modal -->
  <div id="search-engine-modal" class="modal-overlay">
    <div class="modal-content">
      <p class="text-lg font-semibold text-gray-800 mb-4">Look It Up Online:</p>

      <h4 class="text-left text-gray-700 font-semibold border-b border-gray-200 pb-2 mb-3">Web Search</h4>
      <div class="flex flex-col items-center">
        <button id="search-google-choice-btn" class="choice-btn" type="button"><i class="fab fa-google"></i> Search Google</button>
        <button id="search-bing-choice-btn" class="choice-btn" type="button"><i class="fab fa-microsoft"></i> Search Bing</button>
        <button id="search-duckduckgo-choice-btn" class="choice-btn" type="button"><i class="fas fa-search"></i> Search DuckDuckGo</button>
        <button id="search-brave-choice-btn" class="choice-btn" type="button"><i class="fas fa-magnifying-glass"></i> Search Brave</button>
      </div>

      <h4 class="text-left text-gray-700 font-semibold border-b border-gray-200 pb-2 mt-4 mb-3">Translation Services</h4>
      <div class="flex flex-col items-center">
        <button id="translate-google-choice-btn" class="choice-btn" type="button"><i class="fas fa-language"></i> Translate with Google</button>
        <button id="translate-bing-choice-btn" class="choice-btn" type="button"><i class="fas fa-language"></i> Translate with Bing</button>
      </div>

      <h4 class="text-left text-gray-700 font-semibold border-b border-gray-200 pb-2 mt-4 mb-3">Other Actions</h4>
      <div class="flex flex-col items-center">
        <button id="copy-question-btn" class="choice-btn" type="button"><i class="fas fa-copy"></i> Copy Text</button>
      </div>

      <button id="close-search-engine-modal" class="modal-button cancel mt-4" type="button">Cancel</button>
    </div>
  </div>

  <!-- Getting Started Modal -->
  <div id="getting-started-modal" class="modal-overlay">
    <div class="modal-content max-w-sm">
      <h3 class="text-xl font-semibold text-gray-800 mb-3">üöÄ Meaningful Talk</h3>
      <ol class="getting-started-list">
        <li><b>Invite Others:</b> Share the <button id="inline-share-trigger" type="button"><i>QR code or link</i></button> to get everyone onboard.</li>
        <li><b>Pick Questions:</b> On any topic page, tap questions to save them. They‚Äôll appear here as ‚ÄúSaved Items‚Äù.</li>
        <li><b>Discuss:</b> Pick a saved question, then everyone answers it in turn. Repeat with the next person‚Äôs question.</li>
      </ol>
      <div class="modal-buttons mt-4">
        <button id="close-getting-started-modal" class="modal-button cancel" type="button">Got it!</button>
      </div>
    </div>
  </div>

  <!-- QR Code Modal -->
  <div id="qr-code-modal" class="modal-overlay">
    <div id="qr-modal-content" class="modal-content relative">
      <button class="absolute top-2 right-3 text-2xl text-gray-600 hover:text-gray-800" id="qr-modal-close-button" aria-label="Close">&times;</button>
      <h3 class="text-lg font-semibold text-gray-800 mb-2">Share This Page</h3>
      <p class="text-gray-600 text-sm mb-3">Scan the QR code or share the link below:</p>
      <img id="qr-modal-image" alt="QR Code" class="w-full h-auto max-w-xs mx-auto mb-3 rounded shadow" />
      <p class="text-sm text-gray-700 mt-2 break-all">
        <i class="fa-solid fa-link mr-1"></i>
        <a id="qr-page-link" href="#" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline"></a>
      </p>
      <div class="flex gap-2 justify-center mt-3">
        <button id="copy-link-text-link" class="pill"><i class="fas fa-copy mr-1"></i>Copy link</button>
        <button id="share-link-button" class="pill primary"><i class="fas fa-share-from-square mr-1"></i>Share‚Ä¶</button>
      </div>
      <p class="text-gray-500 text-sm mt-4">Let‚Äôs help fellow curious souls launch this page and start the conversation! üòä</p>
    </div>
  </div>

  <script>
    // Random highlight color
    const highlightColors = ["#57FCFF", "#FFFFAD", "#FFC6C6"];
    const randomHighlightColor = highlightColors[Math.floor(Math.random() * highlightColors.length)];
    document.documentElement.style.setProperty('--highlight-color', randomHighlightColor);

    // Keys
    const SAVED_PREFIX = 'csc_saved_questions_';
    const ACTIONS_KEY = 'csc_saved_actions_action_prompts';

    const searchInput = document.getElementById('search-input');
    const resultsEl = document.getElementById('results');
    const emptyStateEl = document.getElementById('empty-state');
    const summaryEl = document.getElementById('summary');
    const clearAllBtn = document.getElementById('clear-all-btn');
    const exportAllBtn = document.getElementById('export-all-btn');
    const expandAllBtn = document.getElementById('expand-all-btn');
    const collapseAllBtn = document.getElementById('collapse-all-btn');
    const actionsMount = document.getElementById('actions-mount');

    // Floating + modals
    const backToTopButton = document.getElementById('back-to-top');
    const floatingLookupBtn = document.getElementById('floating-lookup');
    const floatingShareBtn = document.getElementById('floating-share');

    const searchEngineModal = document.getElementById('search-engine-modal');
    const closeSearchEngineModalBtn = document.getElementById('close-search-engine-modal');
    const searchGoogleChoiceBtn = document.getElementById('search-google-choice-btn');
    const searchBingChoiceBtn = document.getElementById('search-bing-choice-btn');
    const searchDuckDuckGoChoiceBtn = document.getElementById('search-duckduckgo-choice-btn');
    const searchBraveChoiceBtn = document.getElementById('search-brave-choice-btn');
    const translateGoogleChoiceBtn = document.getElementById('translate-google-choice-btn');
    const translateBingChoiceBtn = document.getElementById('translate-bing-choice-btn');
    const copyQuestionBtn = document.getElementById('copy-question-btn');

    // QR + Getting started
    const qrModal = document.getElementById('qr-code-modal');
    const qrImg = document.getElementById('qr-modal-image');
    const qrCloseBtn = document.getElementById('qr-modal-close-button');
    const qrLink = document.getElementById('qr-page-link');
    const qrTrigger = document.getElementById('show-qr-code-link');
    const copyLinkBtn = document.getElementById('copy-link-text-link');
    const shareLinkBtn = document.getElementById('share-link-button');

    const gettingStartedLink = document.getElementById('getting-started-link');
    const gettingStartedModal = document.getElementById('getting-started-modal');
    const closeGettingStartedModalBtn = document.getElementById('close-getting-started-modal');
    const inlineShareTrigger = document.getElementById('inline-share-trigger');

    // Track if QR was opened from Getting Started
    let shouldReturnToGettingStarted = false;

    // Selection
    let selectedText = null;

    // Data loaders
    function readAllSavedQuestions() {
        const topics = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (!key) continue;
          if (key.startsWith(SAVED_PREFIX)) {
            try {
              const raw = localStorage.getItem(key);
              const list = raw ? JSON.parse(raw) : [];
              const topicId = key.substring(SAVED_PREFIX.length);
              const topicName = topicId
                .replace(/_/g, ' ')
                .replace(/\b\w/g, c => c.toUpperCase());
              topics.push({
                key,
                topicId,
                topicName,
                questions: Array.isArray(list) ? list : []
              });
            } catch {}
          }
        }

        // Default alphabetical by topicName
        topics.sort((a, b) => a.topicName.localeCompare(b.topicName));

        // Promote "All In One" (case-insensitive) to the top if it has any saved questions
        const idx = topics.findIndex(
          t => t.topicName.trim().toLowerCase() === 'all in one' && t.questions.length > 0
        );
        if (idx > 0) {
          const [allInOne] = topics.splice(idx, 1);
          topics.unshift(allInOne);
        }

        return topics;
      }


    function readSavedActions() {
      try {
        const raw = localStorage.getItem(ACTIONS_KEY);
        const list = raw ? JSON.parse(raw) : [];
        return Array.isArray(list) ? list : [];
      } catch {
        return [];
      }
    }

    // Helpers
    function stripPrefix(text) {
      try { return text.replace(/^[\p{Emoji_Presentation}\p{Emoji}\p{S}\p{P}\s_]+/u, '').trim(); }
      catch { return text.replace(/^[^A-Za-z0-9]+/, '').trim(); }
    }

    function copyToClipboard(text) {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      alert('Copied to clipboard');
    }

    function saveTopicList(key, list) {
      localStorage.setItem(key, JSON.stringify(list));
    }

    function clearAllSelected() {
      document.querySelectorAll('.selected-chip').forEach(el => el.classList.remove('selected-chip'));
      selectedText = null;
      refreshFloatingVisibility();
    }

    function toggleChipSelection(chipEl, text) {
      const willSelect = !chipEl.classList.contains('selected-chip');
      clearAllSelected();
      if (willSelect) {
        chipEl.classList.add('selected-chip');
        selectedText = text;
      }
      refreshFloatingVisibility();
    }

    function refreshFloatingVisibility() {
      const shouldShow = !!selectedText;
      const displayStyle = shouldShow ? 'flex' : 'none';
      floatingLookupBtn.style.display = displayStyle;
      floatingShareBtn.style.display = displayStyle;
    }

    function render() {
      const query = searchInput.value.trim().toLowerCase();

      const topics = readAllSavedQuestions();
      const totalTopicsWithSaved = topics.filter(t => t.questions.length > 0).length;
      const totalQuestions = topics.reduce((sum, t) => sum + t.questions.length, 0);

      const allActions = readSavedActions();
      const totalActions = allActions.length;
      const filteredActions = query
        ? allActions.filter(a => stripPrefix(a).toLowerCase().includes(query))
        : allActions.slice();

      summaryEl.textContent = `Topics with saved questions: ${totalTopicsWithSaved} ‚Ä¢ Total saved questions: ${totalQuestions} ‚Ä¢ Saved actions: ${totalActions}`;

      resultsEl.innerHTML = '';
      let anyQuestionShown = false;

      topics.forEach(topic => {
        if (topic.questions.length === 0) return;
        const filtered = query
          ? topic.questions.filter(q => stripPrefix(q).toLowerCase().includes(query))
          : topic.questions.slice();
        if (filtered.length === 0) return;

        anyQuestionShown = true;

        const card = document.createElement('div');
        card.className = 'topic-card';

        const header = document.createElement('div');
        header.className = 'flex items-center justify-between flex-wrap gap-2 mb-3';

        const left = document.createElement('div');
        left.className = 'flex items-center gap-2';
        const title = document.createElement('h3');
        title.className = 'text-lg font-semibold section-title';
        title.textContent = topic.topicName;

        const count = document.createElement('span');
        count.className = 'badge';
        count.textContent = `${filtered.length} / ${topic.questions.length}`;

        left.appendChild(title);
        left.appendChild(count);

        const actions = document.createElement('div');
        actions.className = 'flex items-center gap-2';

        const openTopicBtn = document.createElement('a');
        openTopicBtn.className = 'pill';
        openTopicBtn.innerHTML = '<i class="fa-solid fa-up-right-from-square mr-1"></i>Open Topic';
        const kebab = topic.topicId.replace(/_/g, '-');
        openTopicBtn.href = `./${kebab}.html`;
        openTopicBtn.target = '_blank';
        openTopicBtn.rel = 'noopener noreferrer';
        openTopicBtn.title = 'Open topic page';

        const clearTopicBtn = document.createElement('button');
        clearTopicBtn.className = 'pill danger';
        clearTopicBtn.innerHTML = '<i class="fa-solid fa-trash-can mr-1"></i>Clear Topic';
        clearTopicBtn.addEventListener('click', () => {
          if (!confirm(`Clear all saved questions for ‚Äú${topic.topicName}‚Äù?`)) return;
          saveTopicList(topic.key, []);
          render();
        });

        const collapseBtn = document.createElement('button');
        collapseBtn.className = 'pill muted';
        collapseBtn.innerHTML = '<i class="fa-solid fa-angle-up mr-1"></i>Collapse';
        const expandBtn = document.createElement('button');
        expandBtn.className = 'pill muted hidden';
        expandBtn.innerHTML = '<i class="fa-solid fa-angle-down mr-1"></i>Expand';

        actions.appendChild(openTopicBtn);
        actions.appendChild(clearTopicBtn);
        actions.appendChild(collapseBtn);
        actions.appendChild(expandBtn);

        header.appendChild(left);
        header.appendChild(actions);

        const list = document.createElement('div');
        list.className = 'space-y-2';

        (filtered).forEach(q => {
          const chip = document.createElement('div');
          chip.className = 'question-chip';

          const txt = document.createElement('div');
          txt.className = 'question-text wrap-anywhere';
          txt.textContent = q;

          const qa = document.createElement('div');
          qa.className = 'question-actions flex items-center gap-2 shrink-0';

          const copyBtn = document.createElement('button');
          copyBtn.className = 'pill';
          copyBtn.innerHTML = '<i class="fa-solid fa-copy"></i>';
          copyBtn.title = 'Copy';
          copyBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            copyToClipboard(stripPrefix(q));
          });

          const removeBtn = document.createElement('button');
          removeBtn.className = 'pill danger';
          removeBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
          removeBtn.title = 'Remove from saved';
          removeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const current = readAllSavedQuestions().find(t => t.key === topic.key);
            if (!current) return;
            const idx = current.questions.indexOf(q);
            if (idx >= 0) {
              current.questions.splice(idx, 1);
              saveTopicList(topic.key, current.questions);
              render();
            }
          });

          qa.appendChild(copyBtn);
          qa.appendChild(removeBtn);

          chip.appendChild(txt);
          chip.appendChild(qa);

          chip.addEventListener('click', () => toggleChipSelection(chip, q));

          list.appendChild(chip);
        });

        collapseBtn.addEventListener('click', () => {
          list.classList.add('hidden');
          collapseBtn.classList.add('hidden');
          expandBtn.classList.remove('hidden');
        });
        expandBtn.addEventListener('click', () => {
          list.classList.remove('hidden');
          expandBtn.classList.add('hidden');
          collapseBtn.classList.remove('hidden');
        });

        card.appendChild(header);
        card.appendChild(list);
        resultsEl.appendChild(card);
      });

      renderActionsSection(filteredActions, totalActions);

      const anyShown = anyQuestionShown || (totalActions > 0 && filteredActions.length > 0);
      emptyStateEl.classList.toggle('hidden', anyShown);
      if (!anyShown) clearAllSelected();
    }

    function renderActionsSection(filteredActions, totalActions) {
      actionsMount.innerHTML = '';
      if (totalActions === 0) return;

      const section = document.createElement('div');
      section.className = 'mt-2';

      const card = document.createElement('div');
      card.className = 'topic-card';

      const header = document.createElement('div');
      header.className = 'flex items-center justify-between flex-wrap gap-2 mb-3';

      const left = document.createElement('div');
      left.className = 'flex items-center gap-2';

      const title = document.createElement('h3');
      title.className = 'text-lg font-semibold section-title';
      title.textContent = 'Saved Actions';

      const count = document.createElement('span');
      count.className = 'badge';
      count.textContent = `${filteredActions.length} / ${totalActions}`;

      left.appendChild(title);
      left.appendChild(count);

      const right = document.createElement('div');
      right.className = 'flex items-center gap-2';

      const openLink = document.createElement('a');
      openLink.href = './action-prompts.html';
      openLink.target = '_blank';
      openLink.rel = 'noopener noreferrer';
      openLink.className = 'pill';
      openLink.title = 'Open Action Prompts';
      openLink.innerHTML = '<i class="fa-solid fa-up-right-from-square mr-1"></i>Open Actions';

      const clearBtn = document.createElement('button');
      clearBtn.className = 'pill danger';
      clearBtn.title = 'Clear all saved actions';
      clearBtn.innerHTML = '<i class="fa-solid fa-trash-can mr-1"></i>Clear Actions';
      clearBtn.addEventListener('click', () => {
        if (!confirm('Clear all saved actions?')) return;
        localStorage.removeItem(ACTIONS_KEY);
        render();
      });

      const collapseBtn = document.createElement('button');
      collapseBtn.className = 'pill muted';
      collapseBtn.innerHTML = '<i class="fa-solid fa-angle-up mr-1"></i>Collapse';

      const expandBtn = document.createElement('button');
      expandBtn.className = 'pill muted hidden';
      expandBtn.innerHTML = '<i class="fa-solid fa-angle-down mr-1"></i>Expand';

      right.appendChild(openLink);
      right.appendChild(clearBtn);
      right.appendChild(collapseBtn);
      right.appendChild(expandBtn);

      header.appendChild(left);
      header.appendChild(right);

      const list = document.createElement('div');
      list.className = 'space-y-2';

      if (filteredActions.length === 0) {
        const msg = document.createElement('div');
        msg.className = 'subtle text-sm';
        msg.textContent = 'No actions match your search.';
        list.appendChild(msg);
      } else {
        filteredActions.forEach(actionText => {
          const chip = document.createElement('div');
          chip.className = 'action-chip';

          const txt = document.createElement('div');
          txt.className = 'action-text wrap-anywhere';
          txt.textContent = actionText;

          const aa = document.createElement('div');
          aa.className = 'action-actions flex items-center gap-2 shrink-0';

          const copyBtn = document.createElement('button');
          copyBtn.className = 'pill';
          copyBtn.innerHTML = '<i class="fa-solid fa-copy"></i>';
          copyBtn.title = 'Copy';
          copyBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            copyToClipboard(stripPrefix(actionText));
          });

          const removeBtn = document.createElement('button');
          removeBtn.className = 'pill danger';
          removeBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
          removeBtn.title = 'Remove action';
          removeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const all = readSavedActions();
            const idx = all.indexOf(actionText);
            if (idx >= 0) {
              all.splice(idx, 1);
              localStorage.setItem(ACTIONS_KEY, JSON.stringify(all));
              render();
            }
          });

          aa.appendChild(copyBtn);
          aa.appendChild(removeBtn);

          chip.appendChild(txt);
          chip.appendChild(aa);

          chip.addEventListener('click', () => toggleChipSelection(chip, actionText));

          list.appendChild(chip);
        });
      }

      collapseBtn.addEventListener('click', () => {
        list.classList.add('hidden');
        collapseBtn.classList.add('hidden');
        expandBtn.classList.remove('hidden');
      });
      expandBtn.addEventListener('click', () => {
        list.classList.remove('hidden');
        expandBtn.classList.add('hidden');
        collapseBtn.classList.remove('hidden');
      });

      card.appendChild(header);
      card.appendChild(list);
      section.appendChild(card);
      actionsMount.appendChild(section);
    }

    // Interactions
    searchInput.addEventListener('input', () => { render(); });

    clearAllBtn.addEventListener('click', () => {
      if (!confirm('Clear ALL saved items? This cannot be undone.')) return;

      const keys = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith(SAVED_PREFIX)) keys.push(key);
      }
      keys.forEach(k => localStorage.removeItem(k));
      localStorage.removeItem(ACTIONS_KEY);

      render();
      clearAllSelected();
    });

    // Export all saved items to a text file
    function buildExportText() {
      const topics = readAllSavedQuestions();
      const actions = readSavedActions();

      const topicsWithSaved = topics.filter(t => t.questions.length > 0);
      const totalQuestions = topicsWithSaved.reduce((sum, t) => sum + t.questions.length, 0);
      const totalActions = actions.length;

      const lines = [];
      const now = new Date();
      lines.push('Curious Souls Caf√© ‚Äî Saved Items Export');
      lines.push(`Generated: ${now.toLocaleString()}`);
      lines.push(`Topics with saved questions: ${topicsWithSaved.length}`);
      lines.push(`Total saved questions: ${totalQuestions}`);
      lines.push(`Saved actions: ${totalActions}`);
      lines.push('');

      if (topicsWithSaved.length === 0 && totalActions === 0) {
        lines.push('(No saved items found)');
      } else {
        // Topics
        topicsWithSaved.forEach(topic => {
          lines.push(`## ${topic.topicName} (${topic.questions.length})`);
          topic.questions.forEach((q, idx) => {
            const clean = (q || '').toString();
            lines.push(`- ${clean}`);
          });
          lines.push(''); // blank line after each topic
        });

        // Actions
        if (totalActions > 0) {
          lines.push(`## Saved Actions (${totalActions})`);
          actions.forEach(a => {
            const clean = (a || '').toString();
            lines.push(`- ${clean}`);
          });
          lines.push('');
        }
      }

      return lines.join('\n');
    }

    function downloadTextFile(filename, text) {
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    exportAllBtn.addEventListener('click', () => {
      const text = buildExportText();
      downloadTextFile('curious-souls-saved.txt', text);
    });

    expandAllBtn.addEventListener('click', () => {
      document.querySelectorAll('.topic-card .space-y-2').forEach(list => list.classList.remove('hidden'));
      document.querySelectorAll('.topic-card .pill.muted').forEach(btn => {
        const txt = btn.innerText.trim().toLowerCase();
        if (txt.startsWith('expand')) btn.classList.add('hidden');
        if (txt.startsWith('collapse')) btn.classList.remove('hidden');
      });

      const actionsList = actionsMount.querySelector('.space-y-2');
      if (actionsList) actionsList.classList.remove('hidden');
      const allMuted = actionsMount.querySelectorAll('.pill.muted');
      if (allMuted.length >= 2) {
        allMuted[0].classList.remove('hidden');
        allMuted[1].classList.add('hidden');
      }
    });

    collapseAllBtn.addEventListener('click', () => {
      document.querySelectorAll('.topic-card .space-y-2').forEach(list => list.classList.add('hidden'));
      document.querySelectorAll('.topic-card .pill.muted').forEach(btn => {
        const txt = btn.innerText.trim().toLowerCase();
        if (txt.startsWith('expand')) btn.classList.remove('hidden');
        if (txt.startsWith('collapse')) btn.classList.add('hidden');
      });

      const actionsList = actionsMount.querySelector('.space-y-2');
      if (actionsList) actionsList.classList.add('hidden');
      const allMuted = actionsMount.querySelectorAll('.pill.muted');
      if (allMuted.length >= 2) {
        allMuted[0].classList.add('hidden');
        allMuted[1].classList.remove('hidden');
      }
    });

    // Back-to-top
    window.addEventListener('scroll', () => {
      backToTopButton.style.display = window.scrollY > 1 ? 'block' : 'none';
    });
    backToTopButton.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // Lookup modal
    function removeEmojiPrefix(text) {
      try { return text.replace(/^[\p{Emoji_Presentation}\p{Emoji}\p{S}\p{P}\s_]+/u, '').trim(); }
      catch { return text.replace(/^[^A-Za-z0-9]+/, '').trim(); }
    }
    function openChoiceModalIfSelected() {
      if (selectedText) searchEngineModal.classList.add('show');
      else alert('Please select a saved chip first.');
    }
    function closeChoiceModal() { searchEngineModal.classList.remove('show'); }

    floatingLookupBtn.addEventListener('click', openChoiceModalIfSelected);
    closeSearchEngineModalBtn.addEventListener('click', closeChoiceModal);

    function openURL(url) { window.open(url, '_blank'); }
    function doSearch(base) {
      if (!selectedText) return;
      const q = encodeURIComponent(removeEmojiPrefix(selectedText));
      openURL(base + q);
      closeChoiceModal();
    }
    function doTranslate(base) {
      if (!selectedText) return;
      const q = encodeURIComponent(removeEmojiPrefix(selectedText));
      openURL(base + q);
      closeChoiceModal();
    }

    document.getElementById('search-google-choice-btn').addEventListener('click', () => doSearch('https://www.google.com/search?q='));
    document.getElementById('search-bing-choice-btn').addEventListener('click', () => doSearch('https://www.bing.com/search?q='));
    document.getElementById('search-duckduckgo-choice-btn').addEventListener('click', () => doSearch('https://duckduckgo.com/?q='));
    document.getElementById('search-brave-choice-btn').addEventListener('click', () => doSearch('https://search.brave.com/search?q='));
    document.getElementById('translate-google-choice-btn').addEventListener('click', () => doTranslate('https://translate.google.com/?sl=auto&tl=en&text='));
    document.getElementById('translate-bing-choice-btn').addEventListener('click', () => doTranslate('https://www.bing.com/translator/?from=auto&to=en&text='));
    document.getElementById('copy-question-btn').addEventListener('click', () => {
      if (!selectedText) return;
      const ta = document.createElement('textarea');
      ta.value = removeEmojiPrefix(selectedText);
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      alert('Text copied!');
      closeChoiceModal();
    });

    // Share selected
    function buildSharePayload() {
      if (!selectedText) return null;
      return { title: 'Curious Souls Caf√© - Saved Items', text: removeEmojiPrefix(selectedText), url: window.location.href };
    }
    async function shareSelected() {
      const payload = buildSharePayload();
      if (!payload) { alert('Please select a saved chip first.'); return; }
      if (navigator.share) {
        try { await navigator.share(payload); } catch (e) { console.warn('Share canceled/failed:', e); }
      }
    }
    floatingShareBtn.addEventListener('click', shareSelected);

    // Getting Started
    gettingStartedLink.addEventListener('click', () => {
      gettingStartedModal.classList.add('show');
    });
    closeGettingStartedModalBtn.addEventListener('click', () => {
      gettingStartedModal.classList.remove('show');
    });

    // QR Modal + interplay with Getting Started
    function openQRModal(openedFromGettingStarted = false) {
      shouldReturnToGettingStarted = openedFromGettingStarted;
      const pageUrl = window.location.href;
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(pageUrl)}`;
      qrImg.src = qrUrl;
      qrLink.textContent = pageUrl;
      qrLink.href = pageUrl;
      qrModal.classList.add('show');
    }
    function closeQRModal() {
      qrModal.classList.remove('show');
      if (shouldReturnToGettingStarted) {
        gettingStartedModal.classList.add('show');
      }
      shouldReturnToGettingStarted = false;
    }

    qrTrigger.addEventListener('click', (e) => { e.preventDefault(); openQRModal(false); });
    qrCloseBtn.addEventListener('click', closeQRModal);
    qrModal.addEventListener('click', (e) => { if (e.target === qrModal) closeQRModal(); });

    inlineShareTrigger.addEventListener('click', (e) => {
      e.preventDefault();
      gettingStartedModal.classList.remove('show');
      openQRModal(true);
    });

    copyLinkBtn.addEventListener('click', () => {
      const ta = document.createElement('textarea');
      ta.value = window.location.href;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      alert('Link copied to clipboard!');
    });

    shareLinkBtn.addEventListener('click', async () => {
      if (navigator.share) {
        try {
          await navigator.share({
            title: document.title,
            text: 'Join me on Curious Souls Caf√©!',
            url: window.location.href
          });
        } catch (e) { console.warn('Share canceled/failed:', e); }
      }
    });

    // Initial render
    render();
  </script>
</body>
</html>