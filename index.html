<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curious Souls CafÃ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icons/apple-touch-icon.png">
    <meta name="theme-color" content="#a855f7">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(
                to right,
                #f3f4f6 0%,
                #ede9fe 20%,
                #ede9fe 80%,
                #f3f4f6 100%
            );
        }
        .line-break {
            height: 1px; /* Adjust this value */
            width: 100%; /* Make it span the width */
        }
        .topic-button {
            background-color: #a855f7; /* Purple-500 */
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            width: 100%; /* Full width */
            text-align: left; /* Align text to left to make space for star */
            display: flex; /* Use flexbox for alignment of text and star */
            justify-content: space-between; /* Space out text and star */
            align-items: center; /* Vertically align items */
            position: relative; /* For absolute positioning of star */
            padding-right: 3rem; /* Add padding for the star icon */
        }
        .topic-button:hover {
            background-color: #9333ea; /* Purple-600 */
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .topic-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .info-link {
            color: #6b46c1; /* Purple text color */
            font-weight: 600; /* Semi-bold font */
            text-decoration: none;
            transition: color 0.2s ease-in-out, text-decoration 0.2s ease-in-out;
            /* Remove display: block and text-align: center */
        }

        .info-link:hover {
            color: #805ad5; /* Darker purple on hover */
            text-decoration: underline;
        }
        .info-link i {
            margin-right: 0.5rem; /* Space between icon and text */
        }

        /* Styles for the Action Prompts, Roll the Dice, and Submit Questions buttons */
        .action-button { 
            background: linear-gradient(to right, #1A1A1A, #4A4A4A); /* Very Dark Grey to Medium Dark Grey gradient */
            color: white; /* White text for contrast */
            font-weight: bold;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1.125rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            width: 100%;
            transition: all 0.2s ease-in-out;
            display: flex; /* Changed to flex */
            justify-content: space-between; /* Space out text and star */
            align-items: center; /* Vertically align items */
            position: relative; /* For absolute positioning of star */
            padding-right: 3rem; /* Add padding for the star icon */
        }
        .action-button:hover {
            background: linear-gradient(to right, #000000, #333333); /* Even darker gradient on hover */
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .action-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Modal specific styles (duplicated for index.html) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Above all other content */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 300px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }

        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }

        .modal-button {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px; /* Full rounded */
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .modal-button.cancel {
            background-color: #e2e8f0; /* Gray-200 */
            color: #4a5568; /* Gray-700 */
        }
        .modal-button.cancel:hover {
            background-color: #cbd5e0; /* Gray-300 */
        }

        /* Social media icons styling */
        .social-icons a {
            color: #a855f7; /* Purple-500 */
            font-size: 1.8rem; /* Larger icon size */
            transition: color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .social-icons a:hover {
            color: #9333ea; /* Darker purple on hover */
            transform: scale(1.1);
        }

        /* Styling for the Live Discussion button */
        .live-discussion-style {
            background: linear-gradient(to right, #EF4444, #F87171); /* Red to light red gradient */
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1.125rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            width: 100%;
            text-align: center;
            display: block; /* Important for visibility */
            margin-bottom: 1rem; /* Space below the button */
        }
        .live-discussion-style:hover {
            background: linear-gradient(to right, #DC2626, #EF4444); /* Darker red on hover */
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .live-discussion-style:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Loading spinner styles */
        .loading-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #a855f7; /* Purple */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Quote of the Day styles */
        #quote-of-the-day-section {
            background-color: #f0f4f8; /* Light blue-gray */
            border-left: 5px solid #a855f7; /* Purple border */
            padding: 1rem;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        #quote-display {
            font-size: 1.1rem;
            font-style: italic;
            color: #374151; /* Dark gray */
            margin-bottom: 0.5rem;
        }

        #quote-author {
            font-size: 0.9rem;
            color: #6b7280; /* Medium gray */
            font-weight: 600;
        }

        /* Star icon specific styling */
        .star-icon {
            font-size: 1.25rem; /* Slightly larger star */
            color: white; /* Default color, will be overridden for filled */
            cursor: pointer;
            transition: color 0.2s ease-in-out;
            position: absolute;
            right: 1.5rem; /* Position from the right edge of the button */
            top: 50%;
            transform: translateY(-50%);
        }

        .star-icon.fa-solid {
            color: #FFD700; /* Gold color for starred */
        }
        .star-icon:hover {
            color: #FFEA00; /* Lighter gold on hover */
        }
        
        /* AddToHomescreen Button and Modal styles */
        #add-to-homescreen-btn {
            position: fixed;
            bottom: 1.1rem; /* unchanged position relative to dice */
            right: 1.1rem;
            z-index: 3000;
            background: #fff;
            color: #9333ea;
            font-size: 1.02rem; /* tiny bit larger text */
            font-weight: 600;
            border: 2px solid #a855f7;
            border-radius: 1.6rem; /* slightly more rounded */
            padding: 0.66rem 1.08rem; /* slightly larger padding */
            box-shadow: 0 6px 24px rgba(80, 30, 120, 0.08);
            cursor: pointer;
            display: none;
            transition: background 0.2s, color 0.2s;
        }

        #add-to-homescreen-btn.show {
            display: block;
        }

        #add-to-homescreen-btn:hover {
            background: #f3e8ff;
            color: #7c3aed;
        }

        /* iOS Modal */
        #ios-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.44);
            display: none;
            z-index: 4000;
            justify-content: center;
            align-items: center;
        }
        #ios-modal-overlay.show {
            display: flex;
        }
        #ios-modal-content {
            background: white;
            border-radius: 1.2rem;
            box-shadow: 0 8px 32px rgba(50,0,80,.19);
            padding: 2rem 1.2rem 1.5rem 1.2rem;
            max-width: 350px;
            width: 90vw;
            text-align: center;
        }
        #ios-modal-content img {
            width: 38px;
            margin: 0.5rem 0 0.8rem 0;
        }
        #ios-modal-content .close-modal {
            background: #e5e7eb;
            color: #555;
            border: none;
            border-radius: 9999px;
            padding: 0.4rem 1.1rem;
            font-size: 1rem;
            margin-top: 1.2rem;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        #ios-modal-content .close-modal:hover {
            background: #c7d2fe;
        }

        /* Use media queries to shrink the 'add to homescreen button' so it covers less space on small screens. */
        @media (max-width: 600px) {
            #add-to-homescreen-btn {
                padding: 0.55rem 0.9rem; /* slightly larger than before, but still compact */
                font-size: 0.96rem; /* up from 0.9rem */
                border-radius: 1.35rem;
            }
        }

        /* Ensure injected starred action buttons have the same vertical spacing as topics and actions */
        /* space-y-4 = 1rem between items, so we give each injected button a bottom margin of 1rem */
        [data-injected-starred-action="1"] {
            margin-bottom: 1rem;
        }
        /* If multiple starred actions exist, they already get 1rem via margin-bottom above */
        /* Now ensure the block that follows injected starred actions (topics-list) has NO extra margin collapse issue */
        /* Give topics-list a top margin of 0 and rely on the injected buttons' bottom margin to create the gap */
        #topics-list {
            margin-top: 0;
        }

        /* Apply 1rem (same as space-y-4) top margin to topics when starred actions are above */
        #topics-list.has-starred-actions-above {
            margin-top: 1rem;
        }

        /* Floating Dice Button */
        #floating-dice {
            position: fixed;
            bottom: 80px; /* sits above Add to Home button */
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 9999px;
            background: linear-gradient(135deg, #10b981, #06b6d4); /* teal to cyan */
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
            text-decoration: none;
            z-index: 3500; /* above install button */
            transition: transform 0.15s ease-in-out, box-shadow 0.2s ease-in-out, filter 0.2s;
        }
        #floating-dice:hover, #floating-dice:focus {
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 10px 18px rgba(0,0,0,0.2);
            outline: none;
            filter: brightness(1.05);
        }
        #floating-dice:active {
            transform: translateY(0) scale(0.98);
        }
        #floating-dice .fa-dice {
            font-size: 1.4rem;
        }
        @media (max-width: 480px) {
            #floating-dice {
                width: 52px;
                height: 52px;
                bottom: 76px;
                right: 16px;
            }
            #floating-dice .fa-dice {
                font-size: 1.25rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex justify-center items-center min-h-screen p-4">
    <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md transition-transform">
        <div class="flex justify-center mb-6 mt-1">
            <a href="index.html">
                <img src="images/csc_logo.jpg" alt="Curious Souls Cafe Logo" class="w-24 h-24 rounded-full border-2 border-purple-500">
            </a>
        </div>
        <h1 class="text-2xl font-semibold text-purple-600 text-center mb-2">Curious Souls CafÃ©</h1>
        <hr class="border-purple-300 mb-4 w-1/2 mx-auto">

        <!-- Quote of the Day Section -->
        <div id="quote-of-the-day-section">
            <p id="quote-display">Loading quote...</p>
            <p id="quote-author"></p>
        </div>
        
        <h2 class="text-xl font-semibold text-gray-700 text-center mb-2">Pick a Topic:</h2>
        <p class="text-sm text-gray-500 text-center mb-4">
            ðŸ’¡ Tap the star to favorite a topic!
        </p>

        <!-- Live Discussion button container - hidden by default, shown dynamically -->
        <div id="live-discussion-button-container" class="mb-4 hidden">
            <button id="live-discussion-button" class="live-discussion-style">
                Live Discussion
            </button>
        </div>

        <!-- Search Bar -->
        <div class="mb-4">
            <input type="text" id="search-bar" placeholder="Filter topics..."
                   class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
        </div>

        <div id="topics-list" class="space-y-4">
            <div class="loading-spinner"></div>
            <p class="text-gray-500 text-center">Loading topics and questions...</p>
        </div>

        <p id="error-message" class="text-red-500 text-center mt-4 hidden">Failed to load topics. Please check your GitHub repository and network connection.</p>
        
        <!-- Action Buttons Container -->
        <div id="action-buttons-container" class="space-y-4 mt-4"> 
            <!-- Buttons will be dynamically added here by JavaScript -->
        </div>

        <div class="mt-8 pt-4 border-t border-gray-300 text-center">
            <h3 class="text-xl font-semibold text-purple-600 mb-4">Share with friends:</h3>
            <img src="images/qr/qr-code.png" 
                        alt="QR Code to launch app" 
                        class="w-48 h-48 mx-auto rounded-lg shadow-md border border-gray-200 mb-4"
                        onerror="this.onerror=null;this.src='https://placehold.co/192x192/E0E0E0/6B46C1?text=QR+Code+Loading';"
            >
                        
            <p class="text-gray-500 text-sm mt-4" style="margin-top:30px;">Let's help fellow curious souls launch this page and start the conversation! ðŸ˜Š</p>
            
            <p class="text-sm text-gray-700 mt-2">
                <i class="fa-solid fa-link mr-1"></i> 
                <a href="https://curioussoulscafe.github.io" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline break-all">curioussoulscafe.github.io</a>&nbsp;<span class="text-gray-400 text-sm select-none">|</span>&nbsp;&nbsp;<button id="copy-link-text-link" class="text-blue-600 text-sm mt-4 hover:underline"><i class="fas fa-copy"></i></button>&nbsp;&nbsp;<span class="text-gray-400 text-sm select-none">|</span>&nbsp;&nbsp;<button id="share-link-button" class="text-blue-600 text-sm mt-4 hover:underline"><i class="fas fa-share-from-square"></i></button>
            </p>

            <!-- Social Media Icons in a single row -->
            <div class="social-icons flex justify-center w-full space-x-4 mt-4 mb-4">
                <!--
                <a href="https://x.com/curioussoulcafe" target="_blank" rel="noopener noreferrer" aria-label="Follow us on X">
                    <i class="fa-brands fa-x-twitter"></i>
                </a>
                <a href="https://facebook.com/curious.souls.cafe" target="_blank" rel="noopener noreferrer" aria-label="Follow us on Facebook">
                    <i class="fa-brands fa-facebook-f"></i>
                </a>
                <a href="https://www.instagram.com/curious.souls.cafe" target="_blank" rel="noopener noreferrer" aria-label="Follow us on Instagram">
                    <i class="fa-brands fa-instagram"></i>
                </a>
                <a href="https://www.threads.com/@curious.souls.cafe" target="_blank" rel="noopener noreferrer" aria-label="Follow us on Threads">
                    <i class="fa-brands fa-threads"></i>
                </a>
                <a href="https://curioussoulscafe.substack.com" target="_blank" rel="noopener noreferrer" aria-label="Read us on Substack">
                    <i class="fa-solid fa-book-open"></i>
                </a>
                <a href="https://medium.com/@curious.souls.cafe" target="_blank" rel="noopener noreferrer" aria-label="Read us on Medium">
                    <i class="fa-brands fa-medium-m"></i>
                </a>
                <a href="https://github.com/curioussoulscafe/curious-souls-cafe" target="_blank" rel="noopener noreferrer" aria-label="Check out our GitHub">
                    <i class="fa-brands fa-github"></i>
                </a>
                <a href="https://open.spotify.com/playlist/0J2HrFNQ9sNyKpb9PPuH6G" target="_blank" rel="noopener noreferrer" aria-label="Listen on Spotify">
                    <i class="fa-brands fa-spotify"></i>
                </a>
                <a href="https://www.youtube.com/playlist?list=PL7ZT8-PyWbiArNVAThiHiGyxAj33wq6uw" target="_blank" rel="noopener noreferrer" aria-label="Watch on YouTube">
                    <i class="fa-brands fa-youtube"></i>
                </a>
                <a href="mailto:curious.souls.cafe@gmail.com" aria-label="Email us">
                    <i class="fa-solid fa-envelope"></i>
                </a>
                <a href="https://www.goodreads.com/review/list/189570926-curious-souls-cafe?shelf=curious-souls-cafe" target="_blank" rel="noopener noreferrer" aria-label="Books on Goodreads">
                    <i class="fa-solid fa-book"></i>
                </a>
                <a href="https://www.imdb.com/list/ls596985152/" target="_blank" rel="noopener noreferrer" aria-label="Media Content on IMDb">
                    <i class="fa-solid fa-film"></i>
                </a>
                <a href="mailto:curious.souls.cafe@gmail.com" aria-label="Email us">
                    <i class="fa-solid fa-envelope"></i>
                </a>
                -->
                <a href="pages/welcome.html" target="_blank" rel="noopener noreferrer" aria-label="Welcome Leaflet">
                    <i class="fa-solid fa-book-open"></i> </a>
            </div>

            <div class="flex justify-center items-center space-x-3 mt-4">
                <a href="readme.html" target="_blank" rel="noopener noreferrer" class="info-link inline-flex items-center">
                    <i class="fas fa-info-circle mr-1"></i>Guide
                </a>
                <span class="text-gray-400 text-lg select-none">|</span>
                <a href="https://curioussoulscafe.github.io/links/share-feedback" target="_blank" rel="noopener noreferrer" class="info-link inline-flex items-center">
                    <i class="fas fa-comment-dots mr-1"></i>Feedback
                </a>
                <span class="text-gray-400 text-lg select-none">|</span>
                <a href="https://curioussoulscafe.substack.com" target="_blank" rel="noopener noreferrer" class="info-link inline-flex items-center">
                    <i class="fas fa-rss mr-1"></i>Blog
                </a>
            </div>
             <div class="line-break"></div>
        </div>
    </div>

    <!-- Floating Dice Button (links to pages\dice.html) -->
    <a id="floating-dice" href="pages\dice.html" aria-label="Open Dice Roller" title="Open Dice Roller">
        <i class="fas fa-dice"></i>
    </a>

    <!-- Add to Homescreen button -->
    <button id="add-to-homescreen-btn">
        <i class="fa-solid fa-house-medical-circle-check mr-2"></i>
        Add to Home
    </button>

    <!-- iOS Instructions Modal -->
    <div id="ios-modal-overlay">
        <div id="ios-modal-content">
            <img src="images/icons/icon-48.png" alt="CSCafe Icon">
            <h3 class="text-lg font-semibold mb-2 text-purple-600">Add to Home</h3>
            <p class="text-gray-700 mb-2">
                1. Tap the <span style="font-weight:600;">Share</span> <span style="font-size:1.5em;">&#x1f5d2;&#xfe0f;</span> button in the browser.<br>
                2. Scroll and tap <span style="font-weight:600;">"Add to Home"</span>.<br>
                3. Tap <span style="font-weight:600;">Add</span> in the top right.
            </p>
            <button class="close-modal">Close</button>
        </div>
    </div>
    <script>
        const STARRED_TOPICS_KEY = 'csc_starred_topics';
        const STARRED_ACTION_PROMPTS_KEY = 'csc_starred_action_prompts';
        const STARRED_DICE_ROLL_KEY = 'csc_starred_dice_roll';
        const STARRED_SUBMIT_QUESTIONS_KEY = 'csc_starred_submit_questions'; // New key for submit questions button

        const topicsListDiv = document.getElementById('topics-list');
        const errorMessageDiv = document.getElementById('error-message');
        const quoteDisplay = document.getElementById('quote-display');
        const quoteAuthor = document.getElementById('quote-author');
        const searchBar = document.getElementById('search-bar');
        const actionButtonsContainer = document.getElementById('action-buttons-container');

        const quotesTxtUrl = 'data/quotes.txt';
        const quotesLocalStorageKey = 'csc_quotes_data'; 

        const liveDiscussionButtonContainer = document.getElementById('live-discussion-button-container');
        const liveDiscussionButton = document.getElementById('live-discussion-button');

        let allButtons = [];

        const TOPIC_CONFIGS = [
            {
               name: "Live Discussion",
               htmlFileName: "pages/live-discussion.html",
               txtUrl: "questions/live-discussion.txt",
               cache: false
            },
            { name: "Authenticity", htmlFileName: "pages/authenticity.html", txtUrl: "questions/deep-authenticity.txt", cache: true },
            { name: "Icebreaker", htmlFileName: "pages/icebreaker.html", txtUrl: "questions/light-icebreaker.txt", cache: true },
            { name: "Transitions", htmlFileName: "pages/transitions.html", txtUrl: "questions/deep-transitions.txt", cache: true },
            { name: "Reimagine", htmlFileName: "pages/reimagine.html", txtUrl: "questions/deep-reimagine.txt", cache: true },
            { name: "Reflection", htmlFileName: "pages/reflection.html", txtUrl: "questions/mid-reflection.txt", cache: true },
            { name: "Work that Resonates", htmlFileName: "pages/work-that-resonates.html", txtUrl: "questions/light-work-that-resonates.txt", cache: true },
            { name: "Love Relationships", htmlFileName: "pages/love-relationships.html", txtUrl: "questions/mid-love-relationships.txt", cache: true },
            { name: "Happiness", htmlFileName: "pages/happiness.html", txtUrl: "questions/mid-happiness.txt", cache: true },
            { name: "The Mind Speaks", htmlFileName: "pages/the-mind-speaks.html", txtUrl: "questions/deep-the-mind-speaks.txt", cache: true },
            { name: "Parenting", htmlFileName: "pages/parenting.html", txtUrl: "questions/light-parenting.txt", cache: true },
            { name: "Purpose", htmlFileName: "pages/purpose.html", txtUrl: "questions/deep-purpose.txt", cache: true },
            { name: "Friendship", htmlFileName: "pages/friendship.html", txtUrl: "questions/light-friendship.txt", cache: true },
            { name: "Adulthood", htmlFileName: "pages/adulthood.html", txtUrl: "questions/mid-adulthood.txt", cache: true },
            { name: "Interdependence", htmlFileName: "pages/interdependence.html", txtUrl: "questions/mid-interdependence.txt", cache: true },
            { name: "Inner Child", htmlFileName: "pages/inner-child.html", txtUrl: "questions/deep-inner-child.txt", cache: true },
            { name: "All in One", htmlFileName: "pages/all-in-one.html", txtUrl: "questions/mid-all-in-one.txt", cache: true },
            { name: "Entrepreneurship", htmlFileName: "pages/entrepreneurship.html", txtUrl: "questions/light-entrepreneurship.txt", cache: true }
        ];

        // Added: unified starred actions storage (for Action Prompts, Roll the Dice, Import Questions)
        const STARRED_ACTIONS_KEY = 'csc_starred_actions';
        
        /************************************************************************
         * ONE-TIME CACHE CLEARING CODE - START
         * This block clears the old question and quote caches for all users once.
         * You can remove this code in a future update after it has been deployed
         * for a while. The 'cache_cleared_v2' key can be changed if you need
         * to force another refresh in the future (e.g., 'cache_cleared_v3').
         ************************************************************************/
        if (!localStorage.getItem('cache_cleared_v2')) {
            console.log("Performing one-time cache invalidation...");

            // 1. Clear all cached topic question files
            TOPIC_CONFIGS.forEach(topicConfig => {
                if (topicConfig.cache) { // Only attempt to clear items that were cached
                    const oldKey = `csc_topic_${topicConfig.name.replace(/ /g, '_').toLowerCase()}`;
                    localStorage.removeItem(oldKey);
                    console.log(`Removed old cache key: ${oldKey}`);
                }
            });

            // 2. Clear the cached quotes file
            const quotesLocalStorageKey = 'csc_quotes_data';
            localStorage.removeItem(quotesLocalStorageKey);
            console.log(`Removed old cache key: ${quotesLocalStorageKey}`);

            // 3. Set a flag so this script doesn't run again for this user
            localStorage.setItem('cache_cleared_v2', 'true');
            console.log("One-time cache invalidation complete.");
        }
        /************************************************************************
         * ONE-TIME CACHE CLEARING CODE - END
         ************************************************************************/

        function getStarredTopics() {
            const starredTopicsJson = localStorage.getItem(STARRED_TOPICS_KEY);
            return starredTopicsJson ? JSON.parse(starredTopicsJson) : [];
        }

        function setStarredTopics(topics) {
            localStorage.setItem(STARRED_TOPICS_KEY, JSON.stringify(topics));
        }

        function getStarredButtonState(key) {
            const state = localStorage.getItem(key);
            return state === 'true'; // Returns true if 'true', false otherwise (including null)
        }

        function setStarredButtonState(key, isStarred) {
            localStorage.setItem(key, isStarred ? 'true' : 'false');
        }

        // Helpers for action starring
        function getStarredActions() {
            const json = localStorage.getItem(STARRED_ACTIONS_KEY);
            return json ? JSON.parse(json) : []; // array of action names
        }
        function setStarredActions(list) {
            localStorage.setItem(STARRED_ACTIONS_KEY, JSON.stringify(list));
        }
        function toggleActionStar(name) {
            const current = getStarredActions();
            const idx = current.indexOf(name);
            if (idx >= 0) current.splice(idx, 1);
            else current.push(name);
            setStarredActions(current);
        }
        function isActionStarred(name) {
            return getStarredActions().includes(name);
        }

        /**
         * Updates the star icon's visual state.
         * @param {HTMLElement} starElement The <i> element for the star.
         * @param {boolean} isStarred Whether the item is starred.
         */
        function updateStarIcon(starElement, isStarred) {
            if (starElement) {
                if (isStarred) {
                    starElement.classList.remove('fa-regular');
                    starElement.classList.add('fa-solid');
                } else {
                    starElement.classList.remove('fa-solid');
                    starElement.classList.add('fa-regular');
                }
            }
        }

        /**
         * Filters the displayed topic and action buttons based on the search input.
         */
        function filterButtons() {
            const searchTerm = searchBar.value.toLowerCase();
            allButtons.forEach(button => {
                // Get the text content of the span (which holds the topic/action name)
                const buttonTextSpan = button.querySelector('span');
                if (buttonTextSpan) { // Check if span exists for topic/action buttons
                    const buttonText = buttonTextSpan.textContent.toLowerCase();
                    if (buttonText.includes(searchTerm)) {
                        button.style.display = button.classList.contains('live-discussion-style') ? 'block' : 'flex'; // Show the button (using flex display)
                    } else {
                        button.style.display = 'none'; // Hide the button
                    }
                } else if (button.id === 'live-discussion-button') { // Handle live discussion button separately
                    const buttonText = button.textContent.toLowerCase();
                    if (buttonText.includes(searchTerm)) {
                        button.style.display = 'block'; // Live discussion button is block
                    } else {
                        button.style.display = 'none';
                    }
                }
            });
        }

        /**
         * Order topics so that:
         * - If "All in One" is starred, it is first.
         * - Else, starred topics (except "All in One") first (alphabetical),
         *   then "All in One",
         *   then other unstarred topics (alphabetical).
         */
        function orderTopicsWithAllQuestionsPriority(successfulTopics, starredTopics) {
            const ALL = "All in One";

            // Split topics
            const isStarred = t => starredTopics.includes(t.name);
            const isAll = t => t.name === ALL;

            const allTopic = successfulTopics.find(isAll);
            const others = successfulTopics.filter(t => !isAll(t));

            const starredOthers = others.filter(isStarred).sort((a, b) => a.name.localeCompare(b.name));
            const unstarredOthers = others.filter(t => !isStarred(t)).sort((a, b) => a.name.localeCompare(b.name));

            const allIsStarred = allTopic ? starredTopics.includes(ALL) : false;

            if (!allTopic) {
                // Fallback: no "All in One" present; starred first (alpha), then unstarred (alpha)
                const starred = others.filter(isStarred).sort((a, b) => a.name.localeCompare(b.name));
                const unstarred = others.filter(t => !isStarred(t)).sort((a, b) => a.name.localeCompare(b.name));
                return [...starred, ...unstarred];
            }

            if (allIsStarred) {
                // "All in One" on top regardless of others
                return [allTopic, ...starredOthers, ...unstarredOthers];
            } else {
                // Starred others first, then "All in One", then unstarred others
                return [...starredOthers, allTopic, ...unstarredOthers];
            }
        }

        /**
         * Fetches topic content based on TOPIC_CONFIGS and stores in localStorage (selectively).
         * Creates buttons for each topic.
         */
        async function fetchAndCacheTopics() {
            topicsListDiv.innerHTML = '<div class="loading-spinner"></div><p class="text-gray-500 text-center">Loading topics and questions...</p>';
            errorMessageDiv.classList.add('hidden');
            
            let successfulTopics = [];
            let liveDiscussionFound = false;

            // Check for Live Discussion file existence first
            try {
                const liveDiscussionCheckResponse = await fetch('questions/live-discussion.txt', { method: 'HEAD' });
                if (liveDiscussionCheckResponse.ok) {
                    liveDiscussionFound = true;
                    console.log('live-discussion.txt found. Live Discussion button will be shown.');
                }
            } catch (error) {
                console.warn('Could not check for live-discussion.txt:', error);
            }

            for (const topicConfig of TOPIC_CONFIGS) {
                try {
                    const localStorageKey = `csc_topic_${topicConfig.name.replace(/ /g, '_').toLowerCase()}`; 
                    let content = null;

                    if (topicConfig.cache) {
                        content = localStorage.getItem(localStorageKey);
                    }

                    if (!content) {
                        const response = await fetch(topicConfig.txtUrl); 
                        if (!response.ok) {
                            console.warn(`Could not fetch content for ${topicConfig.name} from ${topicConfig.txtUrl}: ${response.statusText}`);
                            continue; 
                        }
                        content = await response.text();
                        if (topicConfig.cache) { 
                            localStorage.setItem(localStorageKey, content);
                            console.log(`Cached content for '${topicConfig.name}'.`);
                        } else {
                            console.log(`Fetched content for '${topicConfig.name}' (not cached).`);
                        }
                    } else {
                        console.log(`Loaded content for '${topicConfig.name}' from localStorage.`);
                    }
                    successfulTopics.push(topicConfig); 
                } catch (error) {
                    console.error(`Error processing topic '${topicConfig.name}':`, error);
                }
            }

            topicsListDiv.innerHTML = ''; 

            // Display Live Discussion button if configured
            if (liveDiscussionFound) {
                liveDiscussionButtonContainer.classList.remove('hidden');
                liveDiscussionButton.addEventListener('click', () => {
                    window.location.href = 'pages/live-discussion.html'; 
                });
            } else {
                liveDiscussionButtonContainer.classList.add('hidden'); 
            }

            if (successfulTopics.length === 0 && !liveDiscussionFound) {
                topicsListDiv.innerHTML = '<p class="text-gray-500 text-center">No topics could be loaded. Please check the topic configurations and file paths.</p>';
                errorMessageDiv.classList.remove('hidden');
            } else {
                const starredTopics = getStarredTopics();

                // Apply custom ordering with "All in One" rules
                const sortedTopics = orderTopicsWithAllQuestionsPriority(successfulTopics, starredTopics);

                sortedTopics.forEach(topic => {
                    const button = document.createElement('button');
                    button.classList.add('topic-button');
                    
                    const topicNameSpan = document.createElement('span');
                    topicNameSpan.textContent = topic.name;
                    topicNameSpan.style.pointerEvents = 'none'; // Ensure clicks on text pass through to button

                    const starIcon = document.createElement('i');
                    starIcon.classList.add('star-icon', 'fa-star'); // Base classes
                    
                    const isStarred = starredTopics.includes(topic.name);
                    updateStarIcon(starIcon, isStarred); // Set initial star icon state

                    // Event listener for the star icon
                    starIcon.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent the button's click event from firing
                        const currentStarred = getStarredTopics();
                        const index = currentStarred.indexOf(topic.name);

                        if (index > -1) {
                            // Topic is already starred, unstar it
                            currentStarred.splice(index, 1);
                        } else {
                            // Topic is not starred, star it
                            currentStarred.push(topic.name);
                        }
                        setStarredTopics(currentStarred);
                        // Re-render topics to apply sorting based on new starred state
                        renderAllContent(); // Re-render all content to re-sort topics
                    });

                    // Event listener for the main button area (for navigation)
                    button.addEventListener('click', () => {
                        window.location.href = topic.htmlFileName;
                    });

                    button.appendChild(topicNameSpan);
                    button.appendChild(starIcon);
                    topicsListDiv.appendChild(button);
                });
            }
        }

        /**
         * Renders the Action Prompts, Roll the Dice, and Import Questions buttons
         * WITHOUT any starring capability.
         */
        function renderActionButtons() {
            actionButtonsContainer.innerHTML = ''; // Clear existing buttons

            const actionButtonsData = [
                // {
                //     name: "Action Prompts",
                //     htmlFileName: "pages/action-prompts.html"
                // },
                // {
                //     name: "Roll the Dice",
                //     htmlFileName: "pages/dice.html"
                // },
                {
                    name: "Import Questions",
                    htmlFileName: "pages/custom-questions-input.html"
                }
            ];

            // Alphabetical order
            actionButtonsData.sort((a, b) => a.name.localeCompare(b.name));

            // Determine starred actions; starred ones must appear above all topics.
            const starredActions = getStarredActions();
            const isStarredAction = name => starredActions.includes(name);

            // We'll create buttons; starred ones will be inserted above topics elsewhere.
            const createActionButton = (buttonData, starred) => {
                const button = document.createElement('button');
                button.classList.add('action-button');
                button.id = buttonData.name.toLowerCase().replace(/ /g, '-') + '-button';

                const buttonNameSpan = document.createElement('span');
                buttonNameSpan.textContent = buttonData.name;
                buttonNameSpan.style.pointerEvents = 'none';

                // Add star icon for these action buttons
                const starIcon = document.createElement('i');
                starIcon.classList.add('star-icon', 'fa-star');
                updateStarIcon(starIcon, starred);

                starIcon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleActionStar(buttonData.name);
                    renderAllContent(); // re-render to reposition
                });

                button.appendChild(buttonNameSpan);
                button.appendChild(starIcon);

                button.addEventListener('click', () => {
                    window.location.href = buttonData.htmlFileName;
                });

                return button;
            };

            // Build buttons and append only unstarred to the container (keep starred for top insertion)
            const unstarredButtons = actionButtonsData
                .filter(a => !isStarredAction(a.name))
                .map(a => createActionButton(a, false));
            unstarredButtons.forEach(btn => actionButtonsContainer.appendChild(btn));

            // Store starred buttons for injection above topics
            const starredButtons = actionButtonsData
                .filter(a => isStarredAction(a.name))
                .sort((a, b) => a.name.localeCompare(b.name))
                .map(a => createActionButton(a, true));

            // Inject starred action buttons above ALL topics and even above All in One
            // Place them just before the topics-list element.
            const parentContainer = document.querySelector('.bg-white.rounded-lg.shadow-xl.p-8.w-full.max-w-md.transition-transform');
            const topicsAnchor = document.getElementById('topics-list');

            // Remove previously injected starred action buttons if any
            document.querySelectorAll('[data-injected-starred-action="1"]').forEach(el => el.remove());

            starredButtons.forEach(btn => {
                btn.setAttribute('data-injected-starred-action', '1');
                parentContainer.insertBefore(btn, topicsAnchor);
            });

            // Ensure consistent spacing between the last injected action and the first topic
            // If we injected any starred actions, add a top margin to topics equal to space-y-4 (1rem)
            if (starredButtons.length > 0) {
                topicsAnchor.classList.add('has-starred-actions-above');
            } else {
                topicsAnchor.classList.remove('has-starred-actions-above');
            }
        }

        /**
         * Fetches quotes from quotes.txt and displays a random one, utilizing localStorage caching.
         */
        async function fetchAndDisplayQuoteOfDay() {
            let quotesText = localStorage.getItem(quotesLocalStorageKey);

            if (!quotesText) {
                console.log("Fetching quotes from network and caching...");
                try {
                    const response = await fetch(quotesTxtUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    quotesText = await response.text();
                    localStorage.setItem(quotesLocalStorageKey, quotesText); // Cache the fetched quotes
                } catch (error) {
                    console.error("Error fetching quotes of the day:", error);
                    quoteDisplay.textContent = "Failed to load quote.";
                    quoteAuthor.textContent = "";
                    return; // Exit if fetch fails
                }
            } else {
                console.log("Loading quotes from localStorage cache.");
            }

            try {
                const quotes = quotesText.split('\n').map(line => line.trim()).filter(line => line.length > 0);

                if (quotes.length > 0) {
                    const randomIndex = Math.floor(Math.random() * quotes.length);
                    const selectedQuote = quotes[randomIndex];
                    
                    const parts = selectedQuote.split('--');
                    let quoteText = parts[0].trim();
                    let authorText = parts.length > 1 ? `-- ${parts[1].trim()}` : '';

                    quoteDisplay.textContent = quoteText;
                    quoteAuthor.textContent = authorText;
                } else {
                    quoteDisplay.textContent = "No quotes available.";
                    quoteAuthor.textContent = "";
                }
            } catch (parseError) {
                console.error("Error parsing quotes:", parseError);
                quoteDisplay.textContent = "Failed to parse quotes.";
                quoteAuthor.textContent = "";
                // Optionally, clear invalid cache if parsing fails
                localStorage.removeItem(quotesLocalStorageKey); 
            }
        }

        /**
         * Renders all dynamic content on the page (topics and action buttons) and applies filtering.
         */
        async function renderAllContent() {
            allButtons = []; // Clear the global list of buttons

            // Render Live Discussion button if applicable
            let liveDiscussionButtonElement = document.getElementById('live-discussion-button');
            if (liveDiscussionButtonElement && !liveDiscussionButtonContainer.classList.contains('hidden')) {
                allButtons.push(liveDiscussionButtonElement);
            }

            await fetchAndCacheTopics(); // This populates topicsListDiv and adds topic buttons to allButtons

            // Render action buttons with starring, ensuring starred actions get injected above topics
            renderActionButtons(); // This populates actionButtonsContainer and injects starred actions above topics

            // After all buttons are rendered, collect them into allButtons for filtering
            allButtons = []
                // Starred action buttons injected above topics (always on top, even above All in One)
                .concat(Array.from(document.querySelectorAll('[data-injected-starred-action="1"]')))
                // Topic buttons
                .concat(Array.from(topicsListDiv.querySelectorAll('.topic-button')))
                // Unstarred action buttons in their container
                .concat(Array.from(actionButtonsContainer.querySelectorAll('.action-button')))
                // Live discussion (if visible)
                .concat(liveDiscussionButtonElement && !liveDiscussionButtonContainer.classList.contains('hidden') ? [liveDiscussionButtonElement] : []);
            
            filterButtons(); // Apply current filter to all rendered buttons
        }

        // Copy Link Button Logic (now a text link)
        const copyLinkTextLink = document.getElementById('copy-link-text-link'); // Changed ID
        copyLinkTextLink.addEventListener('click', function(event) { // Changed to button
            event.preventDefault(); // Prevent default link behavior
            // Use a temporary textarea to copy the fixed URL to clipboard
            const tempInput = document.createElement('textarea');
            tempInput.value = "https://curioussoulscafe.github.io"; // Fixed URL
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            alert("Link copied to clipboard!");
        });

        // Share Link Button Logic (Web Share API only; no fallback)
        const shareLinkButton = document.getElementById('share-link-button');
        shareLinkButton.addEventListener('click', async (event) => {
            event.preventDefault();
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Curious Souls CafÃ©',
                        text: 'Join me at Curious Souls CafÃ©!',
                        url: 'https://curioussoulscafe.github.io'
                    });
                } catch (err) {
                    // Swallow errors silently as requested (no fallback)
                    console.warn('Share canceled or failed:', err);
                }
            }
            // If navigator.share is not available, do nothing (no fallback)
        });

        // Initial load
        fetchAndDisplayQuoteOfDay();
        renderAllContent(); // Call the new main rendering function

        // Add event listener for the search bar
        searchBar.addEventListener('input', filterButtons);

        // Utility: Detect iOS and in Safari
        function isIOS() {
            return /iphone|ipad|ipod/i.test(window.navigator.userAgent);
        }
        function isSafari() {
            return /^((?!chrome|android).)*safari/i.test(window.navigator.userAgent);
        }
        function isInStandaloneMode() {
            return (window.navigator.standalone === true) || window.matchMedia('(display-mode: standalone)').matches;
        }
        function isAndroid() {
            return /android/i.test(window.navigator.userAgent);
        }

        // Add to Homescreen logic
        let deferredPrompt;
        const btn = document.getElementById('add-to-homescreen-btn');
        const iosModal = document.getElementById('ios-modal-overlay');
        const closeIosModalBtn = iosModal.querySelector('.close-modal');

        window.addEventListener('beforeinstallprompt', (e) => {
            // For Chrome/Android PWA
            e.preventDefault();
            deferredPrompt = e;
            if (!isInStandaloneMode()) {
                btn.classList.add('show');
            }
        });

        btn.addEventListener('click', async function() {
            if (isIOS() && isSafari() && !isInStandaloneMode()) {
                // Show iOS instructions modal
                iosModal.classList.add('show');
            } else if (deferredPrompt) {
                // Show Chrome/Android PWA native prompt
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                btn.classList.remove('show');
            } else {
                // Fallback: instructions
                alert('To add this app to your homescreen, use your browser menu and select "Add to Home".');
            }
        });

        closeIosModalBtn.addEventListener('click', () => {
            iosModal.classList.remove('show');
        });

        // Show the button proactively for iOS Safari
        document.addEventListener('DOMContentLoaded', function() {
            if (
                isIOS() && isSafari() && !isInStandaloneMode() &&
                !localStorage.getItem('csc_ios_modal_dismissed')
            ) {
                btn.classList.add('show');
            }
        });

        // Hide the button if already installed
        if (isInStandaloneMode()) {
            btn.classList.remove('show');
        }

        // Dismiss modal and remember
        closeIosModalBtn.addEventListener('click', () => {
            iosModal.classList.remove('show');
            localStorage.setItem('csc_ios_modal_dismissed', '1');
        });

        // Optional: Hide button if installed via event
        window.addEventListener('appinstalled', () => {
            btn.classList.remove('show');
        });

        function updateInstallButtonText() {
            const btn = document.getElementById('add-to-homescreen-btn');
            if (isIOS() && isSafari() && !isInStandaloneMode()) {
                btn.innerHTML = '<i class="fa-solid fa-house-medical-circle-check mr-2"></i>Add to Home';
            } else if (isAndroid() && !isInStandaloneMode()) {
                btn.innerHTML = '<i class="fa-solid fa-house-medical-circle-check mr-2"></i>Add to Home';
            } else {
                // Default to desktop wording
                btn.innerHTML = '<i class="fa-solid fa-download mr-2"></i>Install App';
            }
        }

        function shouldShowInstallButton() {
            // Your existing logic for whether the button should be shown
            return btn.classList.contains('show');
        }

        function updateInstallButtonVisibility() {
            if (!shouldShowInstallButton()) return; // Don't show if not active anyway

            // How close to bottom before hiding? (px)
            const buffer = 120;
            const scrollY = window.scrollY || window.pageYOffset;
            const visibleHeight = window.innerHeight || document.documentElement.clientHeight;
            const fullHeight = document.documentElement.scrollHeight;

            // How far from bottom?
            const distanceFromBottom = fullHeight - (scrollY + visibleHeight);
            if (distanceFromBottom < buffer) {
                btn.style.display = 'none'; // Hide when near bottom
            } else {
                btn.style.display = 'block'; // Show otherwise
            }
        }

        // Re-check on scroll, resize, and page load
        window.addEventListener('scroll', updateInstallButtonVisibility);
        window.addEventListener('resize', updateInstallButtonVisibility);
        window.addEventListener('DOMContentLoaded', updateInstallButtonVisibility);

        // If you ever show/hide the button class in other logic, also call updateInstallButtonVisibility after that.

        // Call after DOMContentLoaded
        document.addEventListener('DOMContentLoaded', updateInstallButtonText);
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
            .then(reg => console.log('Service Worker registered', reg))
            .catch(err => console.warn('Service Worker registration failed:', err));
        }

    </script>    
</body>
</html>
